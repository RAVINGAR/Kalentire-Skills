<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE project>
<project name="Heroes-Skills" default="build" basedir="." xmlns:artifact="antlib:org.apache.maven.artifact.ant">
    <property environment="env"/>
    <property name="build.compiler" value="extJavac" />

    <property name="dir.bin" value="bin" />
    <property name="dir.dist" value="build" />
    <property name="dir.bin.path" value="com/herocraftonline/heroes/characters/skill" />
    <property name="dir.dist.path" value="${ant.project.name}/skills" />
    <property name="dir.maven.dependencies" value ="maven" />
    <property name="used" value="com/herocraftonline/heroes/characters/skill/skills" />
    <property name="unused" value="com/herocraftonline/heroes/characters/skill/unusedskills" />
    <property name="packages" value="skills,pack1,pack2,pack3,pack4,pack5,pack6,pack7,pack8,public1" />

    <property name="totem.lib" value="totem" />

    <!--Classpath used by javac compiler-->
    <path id="classpath">
        <fileset dir="${dir.maven.dependencies}" includes="**/*.jar" excludes="org/bukkit/**/*.jar"/>
    </path>

    <!--Define ant plugins used by this build-->
    <path id="maven-ant-tasks.classpath" path="ant/maven-ant-tasks-2.1.3.jar" />
    <typedef resource="org/apache/maven/artifact/ant/antlib.xml"
             uri="antlib:org.apache.maven.artifact.ant"
             classpathref="maven-ant-tasks.classpath" />
    <taskdef resource="net/sf/antcontrib/antlib.xml">
        <classpath>
            <pathelement location="ant/ant-contrib-1.0b3.jar"/>
        </classpath>
    </taskdef>

    <target name="build">
        <!--Create Maven Dependencies Storage Folder-->
        <mkdir dir="${dir.maven.dependencies}" />

        <!--Populate Maven Dependencies -->
        <artifact:pom id="skillPom" file="pom.xml" />
        <artifact:dependencies filesetId="mavenDependencies" pomRefId="skillPom" />
        <copy todir="${dir.maven.dependencies}">
            <fileset refid="mavenDependencies" />
            <mapper classpathref="maven-ant-tasks.classpath"
                    classname="org.apache.maven.artifact.ant.VersionMapper"
                    from="${dependency.versions}" to="flatten" />
        </copy>
        <!--Make directories required for the build-->
        <mkdir dir="${dir.dist}" />
        <mkdir dir="${dir.bin}" />

    	<for list="${packages}" param="package">
    		<sequential>
            	<mkdir dir="${dir.dist}/${dir.dist.path}" />
                <mkdir dir="${dir.bin}/${dir.dist.path}/@{package}" />
                <javac srcdir="src/com/herocraftonline/heroes/characters/skill" debug="on" destdir="bin" classpathref="classpath" includeantruntime="false" encoding="utf-8" fork="yes" />
                <antcall target="jar-skills">
                	<param name="package" value="@{package}"/>
    			</antcall>
    			<antcall target="jar-skills">
    				<param name="package" value="base"/>
				</antcall>
                <antcall target="jar-totem-lib">
                    <param name="package" value="@{package}"/>
    			</antcall>
                <delete dir="${dir.bin}" includes="**/*.class" excludes="**/*.jar" />
                <antcall target="zip">
                    <param name="package" value="@{package}"/>
                </antcall>
                <!--Make sure to remove the Library Jar file-->
                <delete dir="${dir.dist.path}/@{package}" includes="TotemRecall.jar" />
			</sequential>
		</for>
        <delete dir="${dir.bin}"/>
    	<delete dir="${dir.dist}/${ant.project.name}" />
    	<delete dir="${dir.maven.dependencies}" />
    </target>

    <target name="jar-skills">
        <foreach target="jar-skill" param="file" parallel="false">
            <fileset dir="${dir.bin}/${dir.bin.path}/${package}" includes="Skill*.class" excludes="Skill*$*.class" />
        </foreach>
        <delete file="${dir.bin}/skill.info" />
    </target>

    <target name="jar-skill">
        <basename file="${file}" suffix=".class" property="classname" />
        <echo message="${classname}" />
    	<dirname file="${file}" property="dirname" />
    	<echo message="${dirname}" />
    	<basename file="${dirname}" property="package" />
        <echo message="${package}" />
        <echo file="${dir.bin}/skill.info" message="main-class: com.herocraftonline.heroes.characters.skill.${package}.${classname}" />
        <jar jarfile="${dir.dist}/${dir.dist.path}/${classname}.jar" basedir="${dir.bin}" includes="${dir.bin.path}/${package}/${classname}*.class skill.info">
            <manifest>
                <attribute name="Class-Path" value="../../Heroes.jar" />
            </manifest>
        </jar>
    </target>

	<target name="jar-totem-lib">
        <basename file="SkillTotemRecall" suffix=".class" property="classname" />
        <echo message="${classname}" />
        <echo file="${dir.bin}/skill.info" message="main-class: com.herocraftonline.heroes.characters.skill.skills.${classname}" />
        <jar jarfile="${dir.dist}/${dir.dist.path}/${classname}.jar" basedir="${dir.bin}" includes="${dir.bin.path}/skills/${classname}*.class skill.info ${dir.bin.path}/skills/${totem.lib}/*.class ${dir.bin.path}/skills/${totem.lib}/tasks/*.class">
            <manifest>
                <attribute name="Class-Path" value="../../Heroes.jar" />
            </manifest>
        </jar>
    </target>

    <target name="zip">
        <zip destfile="${dir.dist}/Heroes-${package}.zip">
            <fileset dir="${dir.dist}" includes="*.jar"/>
            <fileset dir="${dir.dist}" includes="${dir.dist.path}/**/*.jar"/>
        </zip>
        <delete dir="${dir.dist}/${dir.dist.path}"/>
    </target>
</project>
