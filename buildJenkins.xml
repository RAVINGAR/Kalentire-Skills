<project name="Heroes" default="build" basedir=".">
    <property environment="env"/>
	
    <property name="dir.bin" value="bin" />
    <property name="dir.dist" value="build" />
    <property name="dir.bin.skills" value="com/herocraftonline/dev/heroes/skill/skills" />
    <property name="dir.dist.skills" value="${ant.project.name}/skills" />

    <path id="classpath">
		<fileset dir="libs" includes="**/*.jar" />
    </path>

    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="../tc-ant/ant-contrib-0.6.jar" />
        </classpath>
    </taskdef>

    <target name="build">
        <mkdir dir="${dir.dist}" />
        <mkdir dir="${dir.dist}/${dir.dist.skills}" />
        <mkdir dir="${dir.bin}" />
        <mkdir dir="${dir.bin}/${dir.dist.skills}" />
    	<echo>Retreiving Libraries</echo>
            <mkdir dir="libs" />
            <echo>- Bukkit</echo>
            <get src="http://ci.bukkit.org/job/dev-CraftBukkit/lastSuccessfulBuild/artifact/target/craftbukkit-0.0.1-SNAPSHOT.jar"
            	dest="libs/craftbukkit.jar" verbose="false" usetimestamp="true" />
    		<echo>- Heroes</echo>
    		<get src="http://ci.onarandombox.com/job/Heroes/lastSuccessfulBuild/artifact/build/Heroes.jar"
    			dest="libs/Heroes.jar" verbose="false" usetimestamp="true" />	
        <javac srcdir="src" destdir="bin" classpathref="classpath" includeantruntime="false"/>
        <antcall target="jar-skills" />
    	<delete dir="${dir.bin}" includes="**/*.class" excludes="**/*.jar" />
    	<antcall target="zip" />
    </target>

    <target name="jar-skills">
        <foreach target="jar-skill" param="files">
            <fileset dir="${dir.bin}/${dir.bin.skills}" includes="Skill*.class" excludes="Skill*$*.class" />
        </foreach>
        <delete file="${dir.bin}/skill.info" />
    </target>

    <target name="jar-skill">
        <basename file="${files}" suffix=".class" property="basename" />
        <echo message="${basename}" />
        <echo file="${dir.bin}/skill.info" message="main-class: com.herocraftonline.dev.heroes.skill.skills.${basename}" />
        <jar jarfile="${dir.dist}/${dir.dist.skills}/${basename}.jar" basedir="${dir.bin}" includes="${dir.bin.skills}/${basename}*.class skill.info">
            <manifest>
                <attribute name="Class-Path" value="../../Heroes.jar" />
            </manifest>
        </jar>
    </target>
	
	<target name="zip">
		<copy todir="${dir.dist}" file="libs/Heroes.jar"/>
		<zip destfile="${dir.dist}/Heroes.zip">
			<fileset dir="${dir.dist}" includes="*.jar"/>
		    <fileset dir="${dir.dist}" includes="${dir.dist.skills}/**/*.jar"/>
		</zip>
		<delete dir="${dir.dist}/${ant.project.name}"/>
	</target>
</project>